<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>移動軌跡取得アプリ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; display: flex; flex-direction: column; }
    #controls { width: 100%; text-align: center; background: rgba(255, 255, 255, 0.9); padding: 10px; border-bottom: 2px solid #ccc; }
    button { margin: 5px; padding: 8px 12px; font-size: 14px; }
    #status { font-size: 14px; color: red; margin-top: 5px; }
    #map { flex-grow: 1; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="startBtn">スタート</button>
    <button id="stopBtn">ストップ</button>
    <button id="showTrackBtn">軌跡表示</button>
    <button id="downloadGeoJSONBtn">GeoJsonダウンロード</button>
    <button id="downloadKMLBtn">KMLダウンロード</button>
    <button id="resetBtn">リセット</button>
    <div id="status"></div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let positions = [];
    let trackLayer = null;
    let inactivityTimer = null;
    let userMarker = null;
    let watchId = null;
    const INACTIVITY_LIMIT = 20 * 60 * 1000;
    const statusElement = document.getElementById("status");
    const map = L.map('map').setView([35.3606, 138.7274], 15);

    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
      attribution: "<a href='https://www.gsi.go.jp/'>国土地理院</a>",
      maxZoom: 18
    }).addTo(map);

    function updateStatus(message) {
      statusElement.textContent = message;
    }

    function downloadData(filename, content, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      updateStatus("データをダウンロードしました。");
    }

    function downloadGeoJSON() {
      if (positions.length === 0) {
        updateStatus("記録された位置がありません。");
        return;
      }
      const geojson = {
        type: "FeatureCollection",
        features: [{
          type: "Feature",
          geometry: { type: "LineString", coordinates: positions.map(p => [p.lng, p.lat]) }
        }]
      };
      downloadData('track.geojson', JSON.stringify(geojson, null, 2), 'application/json');
    }

    function downloadKML() {
      if (positions.length === 0) {
        updateStatus("記録された位置がありません。");
        return;
      }
      let kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><Placemark><LineString><coordinates>`;
      positions.forEach(p => { kml += `${p.lng},${p.lat},0 `; });
      kml += `</coordinates></LineString></Placemark></Document></kml>`;
      downloadData('track.kml', kml, 'application/vnd.google-earth.kml+xml');
    }

    document.getElementById('downloadGeoJSONBtn').addEventListener('click', downloadGeoJSON);
    document.getElementById('downloadKMLBtn').addEventListener('click', downloadKML);
  </script>
</body>
</html>
