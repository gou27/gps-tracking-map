<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>移動軌跡取得アプリ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    #controls { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(255, 255, 255, 0.9); padding: 5px; border-radius: 10px; text-align: center; }
    button { margin: 2px; padding: 8px 12px; font-size: 14px; }
    #status { margin-top: 5px; font-size: 14px; color: red; }
    #map { height: 100vh; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="startBtn">スタート</button>
    <button id="stopBtn">ストップ</button>
    <button id="showTrackBtn">軌跡表示</button>
    <button id="downloadGeoJSONBtn">GeoJsonダウンロード</button>
    <button id="downloadKMLBtn">KMLダウンロード</button>
    <button id="resetBtn">リセット</button>
    <div id="status"></div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let watchId = null;
    let positions = [];
    let trackLayer = null;
    let inactivityTimer = null;
    const INACTIVITY_LIMIT = 20 * 60 * 1000;
    const statusElement = document.getElementById("status");

    function updateStatus(message) {
      statusElement.textContent = message;
    }

    function resetInactivityTimer() {
      if (inactivityTimer) clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        if (watchId !== null) {
          stopTracking();
          updateStatus("20分間操作がなかったため、追跡を中断しました。");
        }
      }, INACTIVITY_LIMIT);
    }

    function startTracking() {
      if (watchId !== null) {
        updateStatus("すでに位置情報を取得中です。");
        return;
      }
      if (!navigator.geolocation) {
        updateStatus("位置情報が利用できません。");
        return;
      }
      updateStatus("位置情報の取得を開始しました。");
      watchId = navigator.geolocation.watchPosition(successCallback, errorCallback, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
      resetInactivityTimer();
    }

    function stopTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        updateStatus("位置情報の取得を停止しました。");
      }
      resetInactivityTimer();
    }

    function successCallback(position) {
      positions.push({ lat: position.coords.latitude, lng: position.coords.longitude, timestamp: position.timestamp });
      updateStatus(`位置取得成功: 緯度${position.coords.latitude}, 経度${position.coords.longitude}`);
      resetInactivityTimer();
    }

    function errorCallback(error) {
      updateStatus(`位置情報エラー: ${error.message}`);
      resetInactivityTimer();
    }

    function showTrack() {
      if (positions.length === 0) {
        updateStatus("記録された位置がありません。");
        return;
      }
      if (trackLayer) map.removeLayer(trackLayer);
      trackLayer = L.polyline(positions.map(p => [p.lat, p.lng]), { color: 'red' }).addTo(map);
      map.fitBounds(trackLayer.getBounds());
      updateStatus("軌跡を表示しました。");
      resetInactivityTimer();
    }

    function resetTracking() {
      positions = [];
      if (trackLayer) map.removeLayer(trackLayer);
      trackLayer = null;
      updateStatus("記録されたデータをリセットしました。");
      resetInactivityTimer();
    }

    document.getElementById('startBtn').addEventListener('click', startTracking);
    document.getElementById('stopBtn').addEventListener('click', stopTracking);
    document.getElementById('showTrackBtn').addEventListener('click', showTrack);
    document.getElementById('resetBtn').addEventListener('click', resetTracking);

    const map = L.map('map').setView([35.3606, 138.7274], 5);
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', { attribution: "<a href='https://www.gsi.go.jp/'>国土地理院</a>" }).addTo(map);

    document.addEventListener('click', resetInactivityTimer);
    document.addEventListener('touchstart', resetInactivityTimer);
  </script>
</body>
</html>
